# 2장. 아키텍처 개요

## 2.1 네 개의 영역

표현, 응용, 도메인, 인프라스트럭처는 아키텍처를 설계할 때 출현하는 전형적인 네 가지 영역이다.

![architecture](https://imgur.com/tyTvHpH.png)

**표현(또는 UI) 영역**은 사용자의 요청을 받아 응용 영역에 전달하고 응용 영역의 처리 결과를 다시 사용자에게 보여주는 역할을 한다. 스프링 MVC 프레임워크가 표현 영역을 위한 기술에 해당한다.

웹 애플리케이션에서 표현 영역의 사용자는 웹 브라우저를 사용하는 사람일 수도 있고, REST API를 호출하는 외부 시스템일 수도 있다.

사용자의 요청을 해석해서 응용 서비스에 전달하고, 응용 서비스의 실행 결과를 사용자가 이해할 수 있는 형식으로 변환하여 응답한다.

표현 영역을 통해 사용자의 요청을 전달받는 **응용 영역**은 시스템이 사용자에게 제공해야 할 기능을 구현한다.

#### 주문 취소 기능을 제공하는 응용 서비스

```java
public class CancelOrderService {

    @Transactional
    public void cancelOrder(String orderId) {
        Order order = findOrderById(orderId);
        if (order == null) throw new OrderNotFoundException(orderId);
        // 응용 서비스는 로직을 직접 수행하기보다는 도메인 모델에 로직 수행을 위임한다.
        order.cancel();
    }
}
```

**응용 영역**은 도메인 모델을 이용해서 사용자에게 제공할 기능을 구현한다. 실제 도메인 로직 구현은 도메인 모델에 위임한다.

**도메인 영역**은 도메인 모델을 구현한다. 도메인 모델은 도메인의 핵심 로직을 구현한다.

**인프라스트럭처 영역**은 구현 기술에 대한 것을 다룬다.

- RDBMS 연동
- 메시징 큐에 메시지 전송/수신
- 데이터 연동
- SMTP 이용한 메일 발송 기능 구현
- HTTP 클라이언트를 이용하여 REST API 호출
  **인프라스트럭처 영역은 논리적인 개념을 표현하기보다는 실제 구현을 다룬다.**

도메인, 응용, 표현 영역은 구현 기술을 사용한 코드를 직접 만들지 않고 인프라스트럭처 영역에서 제공하는 기능을 사용해서 필요한 기능을 개발한다.

- ex) DB에 보관된 데이터가 필요하면 인프라스트럭처 영역의 DB 모듈을 사용하여 데이터를 조회한다.

<br>

## 2.2 계층 구조 아키텍처

### 네 영역을 구성할 때 많이 사용하는 아키텍처

표현 -> 응용 -> 도메인 -> 인프라스트럭처

도메인의 복잡도에 따라 응용과 도메인을 분리하기도 하고 한 계층으로 합치기도 한다.

⭐ **계층 구조는 그 특성상 상위 계층에서 하위 계층으로의 의존만 존재하고 하위 계층은 상위 계층에 의존하지 않는다.**

- ex) 표현 계층은 응용 계층에 의존하지만 응용 계층은 표현 계층을 몰라도 됨

계층 구조를 엄격하게 적용한다면 바로 아래 계층에만 의존을 가져야 하지만 **구현의 편리함을 위해 계층 구조를 유연하게 적용하기도 한다.**

### 인프라스트럭처에 의존하면 발생하는 두 가지 문제점

1. 테스트 어려움
2. 기능 확장의 어려움

두 문제를 해소하는 방법 => **DIP**

<br>

## 2.3 DIP

> **DIP(Dependency Inversion Principle)**
>
> 의존 역전 원칙

#### 고수준 모듈: 의미 있는 단일 기능을 제공하는 모듈

#### 저수준 모듈: 하위 기능을 실제로 구현

고수준 모듈이 제대로 동작하려면 저수준 모듈을 사용해야 한다. 그런데 고수준 모듈이 저수준 모듈을 사용하면 앞서 언급했던 두 가지 문제, 구현 변경과 테스트가 어렵다는 문제가 발생한다.

⭐ DIP는 이 문제를 해결하기 위해 **추상화한 인터페이스**를 사용하여 저수준 모듈이 고수준 모듈에 의존하도록 바꿔준다.

![2.3.dip](https://imgur.com/WusQ90j.png)

만약 CalculateDiscountService가 저수준 모듈에 직접 의존했다면 저수준 모델이 만들어지기 전까지 테스트를 할 수 없었겠지만 CustomerRepository와 RuleDiscounter는 인터페이스이므로 **대역 객체**(Mocking)를 사용해서 테스트를 진행할 수 있다.

**DIP를 적용하여 구현 교체가 어렵다는 것과 테스트가 어려운 문제를 해소할 수 있다.**

### 2.3.1 DIP 주의사항

DIP의 핵심은 고수준 모듈이 저수준 모듈에 의존하지 않도록 하기 위함이다.

DIP를 적용할 때 하위 기능을 추상화한 인터페이스는 고수준 모듈 관점에서 도출한다.

### 2.3.2 DIP와 아키텍처

인프라스트럭처 영역은 구현 기술을 다루는 저수준 모듈이고 응용 영역과 도메인 영역은 고수준 모듈이다.

계층형 구조에서는 인프라스트럭처 영역이 최하단에 위치하지만 DIP를 적용한 아키텍처에서는 인프라스트럭처 영역이 응용/도메인 영역에 의존(상속)하는 구조가 된다.

**DIP를 항상 적용할 필요는 없다.** 상황에 따라 도메인에 코드를 포함시키는게 효과적일 수도 있고 추상화 할 대상이 명확하지 않을 수도 있다. DIP의 이점을 얻는 수준에서 적용 범위를 검토해 보자.

<br>
